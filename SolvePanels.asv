<<<<<<< HEAD
function [lambda, Vt, Cp, Nuemann_check] = SolvePanels(xi, yi, Xj, Yj, phi, U, beta, numPan, S, rho)

%========== PRESCRIBE SOURCE STRENGTHS ==========%
b = zeros(numPan,1); %normal free-stream terms vector (right-hand side of equation)
lambda = zeros(numpan,1); %source strength vector, will store prescribed source strengths

for i = 1:numPan %iterate over the ith panel
    b(i) = U*(cos(alpha)*sin(phi(i)) - sin(alpha)*cos(phi(i))); %compute normal free-stream terms at the ith control point
    lambda(i) = b(i); %prescribing the source strength at the collocation point in accordance with solution to Dirichilet BC for combined
                         %source doublet panel method
end

%%
  %{
%========== READ ME FIRST ==========%
xi = x coordinate for collocation point of ith panel
yi = y coordinate for collocation point of the ith panel
Xj = x-coordinate of starting boundary point for jth panel (X_j+1 would be
the end point)
Yj = y-coordinate of starting boundary point for jth panel (Y_j+1 would be
the end point)
phi =  matrix storing the angles of each panel with respect to the positive
x-axis [radians]
S = matrix containing length of each panel (used to integrate over jth
panel)
numPan =  number of panels 
%}

%% ========== CONVERT COORDINATES TO PANEL COORDINATES ==========%
%{ Solution based on "Low Speed Aerodynamics" by Katz and Plotkin requires
%conversion of global x and y coordinates into local panel coordinates for
%each panel -- the goal of this is to simplify the integrasion by making
%the panel "flat" which gives a constant "y" value for a distance to a
%given point where the potential is analyzed - and the variable of
%integration becomes the new X_j+1 - Xj (which is equivalent in magnitude
%to Sj for the jth panel. 
%}
%% ========== COMPUTE INFLUENCE COEFFICIENTS ==========%
A = zeros(numPan, numPan); %Doublet Potential Influence Coefficient
B = zeros(numPan, numPan); %Source Potential Influence Coefficient

Xo = zeros(numPan); %matrix to store panel length after coordinate transoformation (should equal equivalent S-value, renamed only for clarity)

for f = 1:numPan-1
    for g = 1:numPan-1
        % ===== Convert to Local Panel Coordinates ===== %
        Xt = xi(i) - Xj(j);
        Yt = yi(i) - Yj(j);
        Xt2 = Xj(j+1) - Xj(j);
        Yt2 = Y(j+1) - Yj(j);
        
        X = Xt*cos(phi(j))+Yt*sin(phi(j));
        X2 = Xt2*cos(phi(j)) + Yt2*sin(phi(j));
        Y = Yt*cos(phi(j))-Xt*sin(phi(j));
        Y2 = 0;
        
        Xo(j) = X2; 

        R1 = hypot(X,Y);
        R2 = hypot((X2-X), Y);

        theta1 = atan2(Y,X);
        theta2 = atan2(Y, (X2-X))
        % ===== COMPUTE INFLUENCE COEFFICIENTS =====%
        if i == j 
            A(i,j) = 0.5; %doublet self influence coefficient
            B(i,j) = (lambda(j)/pi)*(X*log(R1)); %source self influence coefficient
        else
            A(i,j) = -(1/(2*pi))*(theta2-theta1); % doublet influence coefficient of the jth panel on the ith control point
            B(i,j) = (lambda(j)/(2*pi))
    end
end


%========== Solve for Panel Strengths ==========%
% lambda = A\b; %SOLVE LINEAR SYSTEM OF EQUATIONS

lambda_ds = lambda(:).*S(:); %vector contraining the strengths of each panel
Nuemann_check = sum(lambda_ds); %checking that the Neumann boundary condition is satisfied (i.e., no penetration into or out of the surface)

%========== Surface Velocity and Aerodynamic Loads ==========%

Vt = zeros(numPan,1); %Panel tangential velocity vector
Cp = zeros(numPan, 1); %Panel Pressure coefficient vector
                                                               
for i = 1:numPan
    source_terms = 0;
    for j = 1:numPan
        source_terms = source_terms + (lambda(j)/(2*pi))*(J(i,j)); %contribution of all other jth panels to tangent velocity of ith panel 
    end
    Vt(i) = U*sin(beta(i)) + source_terms; %surface velocity at ith control point
    Cp(i) = 1-(Vt(i)/U)^2; %pressure coefficient evaluated at ith control point
=======
function [lambda, mu, dphi_ds, Cp, Nuemann_check, A, B, pot, RHS, DL] = SolvePanels(xi, yi, Xj, Yj, S, phi, U, beta, numPan, rho, alpha)
mu = zeros(numPan,1); %matrix to store doublet strengths
% ========== PRESCRIBE SOURCE STRENGTHS ========== %
b = zeros(numPan,1); %normal free-stream terms vector (right-hand side of equation)
lambda = zeros(numPan,1); %source strength vector, will store prescribed source strengths

for i = 1:numPan %iterate over the ith panel
    b(i) = U*(cos(alpha)*sin(beta(i) - sin(alpha)*cos(beta(i)))); %compute normal free-stream terms at the ith control point
    lambda(i) = b(i); %prescribing the source strength at the collocation point in accordance with solution to Dirichilet BC for combined
                         %source doublet panel method
end

% ========== BUILD COORDINATES AND COMPUTE INFLUENCE COEFFICIENTS ========== %
A = zeros(numPan, numPan+1); %Doublet Potential Influence coefficient Matrix
B = zeros(numPan, numPan); %Source Potential Influence Coefficient Matrix

for i = 1:numPan
    for j = 1:numPan

        % ===== Perform Transformation into Local jth Panel Coordinates ===== %
        Xt1 = xi(i) - Xj(j);
        Yt1 = yi(i) - Yj(j);
        Xt2 = Xj(j+1) - Xj(j);
        Yt2 = Yj(j+1) - Yj(j);

        Xo = Xt1*cos(phi(j)) + Yt1*sin(phi(j));
        Yo = Yt1*cos(phi(j)) - Xt1*sin(phi(j))-1E-2;
        Xf = Xt2*cos(phi(j)) + Yt2*sin(phi(j));
        Yf = 0; 

        if i == 1
            DL(j) = Xf;
        end

        R1 = sqrt(Xo^2 + Yo^2);
        R2 = sqrt((Xo-Xf)^2 + Yo^2);

        theta_1 = atan2(Yo, Xo);
        theta_2 = atan2(Yo, (Xo-Xf));

        if (i == j)
            B(i,j) = (lambda(j)/pi)*(Xo*log(R1));
            A(i,j) = 0.5; %ith panel doublet self-influence coefficient
        elseif (i ~= j)
             B(i,j) = (lambda(j)/(2*pi))*(Xo*log(R1) - (Xo-Xf)*log(R2) + Yo*(theta_2-theta_1)); %influence coefficient of jth source on the ith control point
             A(i,j) = (1/(2*pi))*(theta_2-theta_1); %influence Coefficient of the jth doublet on the ith control point
             
        end
    end
    XW = xi(i)-Xj(numPan);
    YW = yi(i)-Yj(numPan);
    theta_w = -atan(YW/XW);

    A(i,numPan+1) = -(1/(2*pi))*theta_w;
end


for i = 1:numPan
    for j = 1:numPan
        if (j ~= 1) && (j ~= numPan)
            A(i,j) = A(i,j);
        elseif j == 1
            A(i,j) = A(i,j)-A(i,numPan+1);
        elseif j == numPan
            A(i,j) = A(i,numPan)+A(i,numPan+1);
        end
    end
end

A(:, end) = [];
size(A)
RHS = sum(B, 2);
size(RHS)

mu = -RHS\A; %solve for doublet strengths
pot = zeros(numPan,1);

mu_ds = mu(:).*S(:);
Circulation = sum(mu_ds)
lift = rho*U*Circulation;




for i = 1:numPan
    pot(i) = xi(i)*cos(alpha) + yi(i)*sin(alpha) + sum(mu.*A(i,:)) + sum(B(i,:));
end
% central differences for interior points
dphi_ds = zeros(numPan,1);

for i = 2:numPan-1
    ds_forward  = S(i);
    ds_backward = S(i-1);
    dphi_ds(i) = (pot(i+1) - pot(i-1)) / (ds_forward + ds_backward);
end

% one-sided differences at ends
dphi_ds(1)   = (pot(2) - pot(1)) / S(1);
dphi_ds(numPan)   = (pot(numPan) - pot(numPan-1)) / (S(1) + S(numPan-1));

for i = 1:numPan-1
    % R = (DL(i+1)+DL(i))/2;
    % Vt(i) = (pot(i)-pot(i+1))/R;
    Cp(i) = 1-dphi_ds(i)^2;
    % Cl(i) = (2*lift)/(rho*Vt(i)^2*S(i));
end

% S_tot = sum(S); %total length of curve bounding airfoil
% F_lift = sum(Cl(:).*S(:)); %comparison lift formula
% dp = 0.5*rho*U; %dynamic pressure term
% Cl_tot = F_lift/(dp*S_tot); %NET LIFT COEFFICIENT OF AIRFOIL 

lambda_ds = lambda(:).*S(:); %vector contraining the strengths of each panel
Nuemann_check = sum(lambda_ds); %checking that the Neumann boundary condition is satisfied (i.e., no penetration into or out of the surface)
>>>>>>> origin/main
end
